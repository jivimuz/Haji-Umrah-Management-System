<?php
 namespace App\Http\Middleware; use Closure; use Illuminate\Support\Facades\Auth; use App\Models\JwtToken; use App\Models\Serial; use Carbon\Carbon; use Illuminate\Support\Facades\DB; use Illuminate\Support\Facades\Http; class AuthApiMiddleware { public function handle($request, Closure $next) { if ($request->is("\x61\x70\x69\57\x2a")) { if (!$request->is("\141\x70\x69\x2f\x61\165\164\x68\57\x72\x65\x67\151\x73\164\145\x72") && !$request->is("\141\x70\151\x2f\141\x75\164\x68\57\x6c\157\147\x69\156")) { if (!Auth::guard("\x61\x70\151")->check()) { return response()->json(array("\x73\x74\x61\x74\165\163" => false, "\x6d\145\x73\163\x61\147\145" => "\x55\x6e\141\165\164\150\157\x72\151\x7a\145\144"), 401); } if (!JwtToken::fnIsTokenActive($request->bearerToken())) { return response()->json(array("\163\164\141\164\x75\163" => false, "\155\145\x73\x73\x61\147\x65" => "\125\156\x61\165\164\150\x6f\162\x69\172\145\x64"), 401); } } } $type = env("\x54\x59\x50\105\x5f\114\x4f\x43\x41\x4c\137\x53\x45\122\x56\x45\122", 0); if (!$type == 2) { $serial = Serial::first(); if (!$serial) { return redirect()->route("\x65\162\x72\x6f\162")->with("\151\x73\x45\170\160\151\162\145\x64", true); } $endpoint = env("\101\125\x54\110\x5f\x53\105\122\126\x45\x52", "\x68\x74\x74\x70\x73\x3a\x2f\x2f\x73\145\x72\x69\x61\154\x6d\141\x6e\x61\x67\x65\x72\x2e\x61\163\166\x61\164\157\x75\162\x2e\163\151\164\145\57\141\x75\x74\x68\157\162\x69\172\141\x74\151\x6f\156"); $response = Http::get($endpoint, array("\x73\145\162\151\141\x6c\x5f\143\157\x64\145" => $serial->serial_code)); if ($type == 0) { $data = $response->json(); $now = Carbon::now(); $twoWeeksLater = $now->copy()->addWeeks(2); if ($data && isset($data["\x64\141\164\x61"]["\x76\x61\x6c\151\144\x5f\165\156\164\151\154"])) { $expiryDate = Carbon::parse($data["\x64\x61\164\x61"]["\x76\x61\154\x69\x64\x5f\165\x6e\164\151\x6c"]); DB::table("\x73\x65\162\151\141\x6c")->update(array("\x76\141\x6c\151\x64\x5f\165\156\x74\x69\x6c" => $data["\x64\x61\164\x61"]["\166\141\154\x69\144\x5f\x75\156\x74\151\154"])); if ($expiryDate->lessThanOrEqualTo(Carbon::yesterday())) { return redirect()->route("\145\162\x72\157\162")->with("\x69\x73\x45\x78\160\151\x72\x65\144", true); } if ($expiryDate->lessThanOrEqualTo($twoWeeksLater)) { session()->flash("\x65\170\x70\x69\x72\x65\x64\x41\x6c\145\x72\164", true); session()->flash("\145\x78\160\151\162\x65\x64\x44\x61\x74\x65", "\101\x70\x70\40\167\x69\x6c\154\x20\x62\x65\40\x62\154\x6f\143\153\145\144\x20\x61\x74\x20" . $data["\144\141\x74\x61"]["\x76\x61\x6c\x69\x64\137\165\156\164\x69\154"]); } } } $expiryDate = Carbon::parse($serial->valid_until); if ($expiryDate->lessThanOrEqualTo(Carbon::yesterday())) { return redirect()->route("\x65\162\162\x6f\162")->with("\x69\163\x45\x78\x70\x69\x72\x65\x64", true); } if ($expiryDate->lessThanOrEqualTo($twoWeeksLater)) { session()->flash("\x65\x78\x70\151\162\x65\144\101\x6c\x65\x72\x74", true); session()->flash("\x65\x78\x70\151\162\x65\x64\104\x61\164\x65", "\101\x70\x70\40\x77\x69\x6c\x6c\40\142\145\40\x62\154\157\x63\153\145\144\40\141\164\40" . $serial->valid_until); } } return $next($request); } }
